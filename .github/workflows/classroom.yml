name: Autograding Tests (Linux Shell/Grep)

on:
  push:
  workflow_dispatch:
  repository_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # The following steps use 'grep' and conditional shell logic to replicate your checks.
    # Paths use forward slashes '/'.

    # ========================================================
    # 1. PersonModel (7 Points Total)
    # ========================================================
    - name: PersonModel Class & Properties (5 pts)
      id: person-class
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: PersonModel Class
        # Checks for Class definition AND Id, FirstName, LastName
        command: |
          grep -E 'class\s+PersonModel' OOP.FinalTerm.Exam/Model/PersonModel.cs && \
          grep -E 'Id' OOP.FinalTerm.Exam/Model/PersonModel.cs && \
          grep -E 'FirstName' OOP.FinalTerm.Exam/Model/PersonModel.cs && \
          grep -E 'LastName' OOP.FinalTerm.Exam/Model/PersonModel.cs
        timeout: 10
        max-score: 5

    - name: PersonModel SQLite Attributes (2 pts)
      id: person-attribs
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: PersonModel Attributes
        # Checks for PrimaryKey and AutoIncrement
        command: |
          grep -E '\[PrimaryKey' OOP.FinalTerm.Exam/Model/PersonModel.cs && \
          grep -E 'AutoIncrement' OOP.FinalTerm.Exam/Model/PersonModel.cs
        timeout: 10
        max-score: 2

    # ========================================================
    # 2. DirectorModel (6 Points Total)
    # ========================================================
    - name: DirectorModel Inheritance (3 pts)
      id: director-inherit
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorModel Inheritance
        # Checks if DirectorModel inherits PersonModel
        command: grep -E 'class\s+DirectorModel\s*:\s*PersonModel' OOP.FinalTerm.Exam/Model/DirectorModel.cs
        timeout: 10
        max-score: 3

    - name: DirectorModel Properties (3 pts)
      id: director-props
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorModel Properties
        # Checks for Genres and TotalMoviesCreated
        command: |
          grep -E 'Genres' OOP.FinalTerm.Exam/Model/DirectorModel.cs && \
          grep -E 'TotalMoviesCreated' OOP.FinalTerm.Exam/Model/DirectorModel.cs
        timeout: 10
        max-score: 3

    # ========================================================
    # 3. DirectorRepository (12 Points Total)
    # ========================================================
    - name: DirectorRepo Constructor (3 pts)
      id: repo-ctor
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorRepo Constructor
        # Checks for SQLiteConnection and CreateTable, ensuring no commented code is found (using || to fail the test)
        command: |
          grep -E 'new\s*SQLiteConnection' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs && \
          grep -E '\.CreateTable' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs && \
          ! grep -E '//.*new\s*SQLiteConnection' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs
        timeout: 10
        max-score: 3

    - name: DirectorRepo AddDirector (3 pts)
      id: repo-add
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorRepo AddDirector
        # Checks for uncommented Insert method call
        command: grep -v '^//' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs | grep -E 'Insert'
        timeout: 10
        max-score: 3

    - name: DirectorRepo GetAll (3 pts)
      id: repo-getall
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorRepo GetAll
        # Checks for uncommented Table and ToList
        command: |
          grep -v '^//' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs | grep -E '\.Table' && \
          grep -v '^//' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs | grep -E '\.ToList'
        timeout: 10
        max-score: 3

    - name: DirectorRepo GetById (3 pts)
      id: repo-getbyid
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorRepo GetById
        # Checks for uncommented Find method call
        command: grep -v '^//' OOP.FinalTerm.Exam/Repository/DirectorRepository.cs | grep -E '\.Find'
        timeout: 10
        max-score: 3

    # ========================================================
    # 4. DirectorForm (9 Points Total)
    # ========================================================
    - name: DirectorForm Controls (3 pts)
      id: form-controls
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorForm Controls
        # Checks Designer file for control names
        command: |
          grep -E 'txtFirstName' OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs && \
          grep -E 'txtLastName' OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs && \
          grep -E 'txtGenres' OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs && \
          grep -E 'numTotalMovies' OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs
        timeout: 10
        max-score: 3

    - name: DirectorForm GetDirector (3 pts)
      id: form-getdirector
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorForm GetDirector
        # Checks mapping logic
        command: |
          grep -E 'public.*GetDirector' OOP.FinalTerm.Exam/Views/DirectorForm.cs && \
          grep -E 'FirstName' OOP.FinalTerm.Exam/Views/DirectorForm.cs && \
          grep -E 'return' OOP.FinalTerm.Exam/Views/DirectorForm.cs
        timeout: 10
        max-score: 3

    - name: DirectorForm Validation (3 pts)
      id: form-validation
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: DirectorForm Validation
        # Checks for validation logic in Save Click
        command: |
          grep -E 'BtnSave_Click' OOP.FinalTerm.Exam/Views/DirectorForm.cs && \
          grep -E 'IsNullOrWhiteSpace' OOP.FinalTerm.Exam/Views/DirectorForm.cs && \
          grep -E 'MessageBox.Show' OOP.FinalTerm.Exam/Views/DirectorForm.cs
        timeout: 10
        max-score: 3

    # ========================================================
    # 5. SettingsForm (4 Points Total)
    # ========================================================
    - name: SettingsForm Load (4 pts)
      id: settings-load
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: SettingsForm Load
        # Checks LoadDirectorsToGrid logic
        command: |
          grep -E 'LoadDirectorsToGrid' OOP.FinalTerm.Exam/Views/SettingsForm.cs && \
          grep -E 'GetAllDirectors' OOP.FinalTerm.Exam/Views/SettingsForm.cs && \
          grep -E 'dgvDirectors' OOP.FinalTerm.Exam/Views/SettingsForm.cs
        timeout: 10
        max-score: 4

    # ========================================================
    # 6. Compilation (2 Points Total)
    # ========================================================
    - name: Project Compilation (2 pts)
      id: compilation
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: Project Compilation
        # Attempts to build the project
        command: "dotnet build ./OOP.FinalTerm.Exam/OOP.FinalTerm.Exam.csproj"
        timeout: 30
        max-score: 2

    # ========================================================
    # Reporter
    # ========================================================
    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      with:
        runners: person-class,person-attribs,director-inherit,director-props,repo-ctor,repo-add,repo-getall,repo-getbyid,form-controls,form-getdirector,form-validation,settings-load,compilation