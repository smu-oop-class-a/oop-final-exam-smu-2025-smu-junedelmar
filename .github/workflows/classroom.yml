name: Autograding Tests

on:
  push:
  workflow_dispatch:
  repository_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  autograde:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # TEST 1 — PersonModel class + properties  (5 points)
      # ----------------------------------------------------------
      - name: PersonModel Class
        id: test-personmodel
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: PersonModel Class
          command: "grep -R \"class PersonModel\" -n OOP.FinalTerm.Exam/Model || true"
          expected-output: "PersonModel"
          comparison-method: contains
          points: 5

      # ----------------------------------------------------------
      # TEST 2 — SQLite attributes (2 points)
      # ----------------------------------------------------------
      - name: PersonModel Attributes
        id: test-person-attributes
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: SQLite Attributes
          command: "grep -R \"PrimaryKey\" OOP.FinalTerm.Exam/Model/PersonModel.cs || true"
          expected-output: "PrimaryKey"
          comparison-method: contains
          points: 2

      # ----------------------------------------------------------
      # TEST 3 — DirectorModel inherits PersonModel (3 points)
      # ----------------------------------------------------------
      - name: DirectorModel Inheritance
        id: test-dir-inherit
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: DirectorModel Inheritance
          command: "grep -R \"class DirectorModel .*: PersonModel\" OOP.FinalTerm.Exam/Model || true"
          expected-output: ": PersonModel"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 4 — DirectorModel properties (Genres + TotalMoviesCreated) (3 points)
      # ----------------------------------------------------------
      - name: DirectorModel Properties
        id: test-dir-props
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: DirectorModel Properties
          command: |
            grep -R \"Genres\" OOP.FinalTerm.Exam/Model/DirectorModel.cs &&
            grep -R \"TotalMoviesCreated\" OOP.FinalTerm.Exam/Model/DirectorModel.cs || true
          expected-output: "TotalMoviesCreated"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 5 — Repository AddDirector uses Insert() (3 points)
      # ----------------------------------------------------------
      - name: AddDirector Method
        id: test-adddirector
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: AddDirector Insert()
          command: "grep -R \"Insert\" OOP.FinalTerm.Exam/Repository/DirectorRepository.cs || true"
          expected-output: "Insert"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 6 — GetAllDirectors uses Table().ToList() (3 points)
      # ----------------------------------------------------------
      - name: GetAllDirectors Method
        id: test-getall
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: GetAllDirectors
          command: "grep -R \"Table.*ToList\" OOP.FinalTerm.Exam/Repository/DirectorRepository.cs || true"
          expected-output: "ToList"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 7 — GetDirectorById uses Find() (3 points)
      # ----------------------------------------------------------
      - name: GetDirectorById Method
        id: test-getbyid
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: GetDirectorById
          command: "grep -R \"Find\" OOP.FinalTerm.Exam/Repository/DirectorRepository.cs || true"
          expected-output: "Find"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 8 — DirectorForm controls exist (3 points)
      # ----------------------------------------------------------
      - name: DirectorForm Controls
        id: test-controls
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: Form Controls
          command: |
            grep -R \"txtFirstName\" OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs &&
            grep -R \"txtLastName\" OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs &&
            grep -R \"txtGenres\" OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs &&
            grep -R \"numTotalMovies\" OOP.FinalTerm.Exam/Views/DirectorForm.Designer.cs || true
          expected-output: "numTotalMovies"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 9 — Validation in BtnSave_Click (3 points)
      # ----------------------------------------------------------
      - name: Validation Check
        id: test-validation
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: Validation
          command: "grep -R \"IsNullOrWhiteSpace\" OOP.FinalTerm.Exam/Views/DirectorForm.cs || true"
          expected-output: "IsNullOrWhiteSpace"
          comparison-method: contains
          points: 3

      # ----------------------------------------------------------
      # TEST 10 — LoadDirectorsToGrid (4 points)
      # ----------------------------------------------------------
      - name: LoadDirectorsToGrid
        id: test-loadgrid
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: LoadDirectorsToGrid
          command: "grep -R \"LoadDirectorsToGrid\" OOP.FinalTerm.Exam/Views/SettingsForm.cs || true"
          expected-output: "LoadDirectorsToGrid"
          comparison-method: contains
          points: 4

      # ----------------------------------------------------------
      # TEST 11 — Compilation check (2 points)
      # ----------------------------------------------------------
      - name: Compilation Check
        id: test-compilation
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: Compilation
          command: |
            test -f OOP.FinalTerm.Exam/OOP.FinalTerm.Exam.csproj
          expected-output: ""
          comparison-method: exact
          points: 2

      # ----------------------------------------------------------
      # REPORTER
      # ----------------------------------------------------------
      - name: Autograding Reporter
        uses: classroom-resources/autograding-grading-reporter@v1
        env:
          TEST-PERSONMODEL_RESULTS: ${{ steps.test-personmodel.outputs.result }}
          TEST-PERSON-ATTRIBUTES_RESULTS: ${{ steps.test-person-attributes.outputs.result }}
          TEST-DIR-INHERIT_RESULTS: ${{ steps.test-dir-inherit.outputs.result }}
          TEST-DIR-PROPS_RESULTS: ${{ steps.test-dir-props.outputs.result }}
          TEST-ADDDIRECTOR_RESULTS: ${{ steps.test-adddirector.outputs.result }}
          TEST-GETALL_RESULTS: ${{ steps.test-getall.outputs.result }}
          TEST-GETBYID_RESULTS: ${{ steps.test-getbyid.outputs.result }}
          TEST-CONTROLS_RESULTS: ${{ steps.test-controls.outputs.result }}
          TEST-VALIDATION_RESULTS: ${{ steps.test-validation.outputs.result }}
          TEST-LOADGRID_RESULTS: ${{ steps.test-loadgrid.outputs.result }}
          TEST-COMPILATION_RESULTS: ${{ steps.test-compilation.outputs.result }}